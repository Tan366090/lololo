<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta
            http-equiv="Content-Security-Policy"
            content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com http://localhost:4000 http://localhost; object-src 'none';"
        />
        <title>Chấm công hằng ngày - VNPT</title>
        
        <!-- External CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
        
        <!-- Internal CSS -->
        <link rel="stylesheet" href="css/attendance.css" />
        <link rel="stylesheet" href="/assets/css/notifications.css">
        <link rel="stylesheet" href="/assets/css/loading.css">
        <link rel="stylesheet" href="/assets/css/style.css">
        <link rel="stylesheet" href="css/common.css">
        
        <style>
            :root {
                /* Color Variables */
                --primary-color: #2563eb;
                --primary-hover: #1d4ed8;
                --secondary-color: #64748b;
                --success-color: #22c55e;
                --danger-color: #ef4444;
                --warning-color: #f59e0b;
                --info-color: #3b82f6;
                --light-color: #f8fafc;
                --dark-color: #1e293b;
                --border-color: #e2e8f0;
                --text-primary: #1e293b;
                --text-secondary: #475569;
                
                /* Spacing Variables */
                --spacing-xs: 0.25rem;
                --spacing-sm: 0.5rem;
                --spacing-md: 1rem;
                --spacing-lg: 1.5rem;
                --spacing-xl: 2rem;
                
                /* Border Radius */
                --border-radius-sm: 0.375rem;
                --border-radius-md: 0.5rem;
                --border-radius-lg: 0.75rem;
                
                /* Shadows */
                --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
                --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
                --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
                
                /* Transitions */
                --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
                --transition-normal: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* Base Styles */
            body {
                font-family: 'Inter', system-ui, -apple-system, sans-serif;
                background-color: #f1f5f9;
                color: var(--text-primary);
                line-height: 1.6;
            }

            /* Layout */
            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: var(--spacing-lg);
            }

            .main-content {
                background: white;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-md);
                padding: var(--spacing-xl);
                min-height: calc(100vh - 40px);
            }

            /* Navigation */
            .attendance-nav {
                background: white;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-sm);
                padding: var(--spacing-lg);
                margin-bottom: var(--spacing-lg);
            }

            .nav-buttons {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: var(--spacing-md);
            }

            .nav-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: var(--spacing-sm);
                padding: var(--spacing-md) var(--spacing-lg);
                background-color: var(--light-color);
                color: var(--text-secondary);
                border-radius: var(--border-radius-md);
                text-decoration: none;
                font-weight: 500;
                transition: all var(--transition-normal);
                border: 1px solid var(--border-color);
            }

            .nav-btn:hover {
                background-color: var(--primary-color);
                color: white;
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

            .nav-btn ion-icon {
                font-size: 1.2rem;
            }

            /* Header */
            .content-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: var(--spacing-xl);
                padding-bottom: var(--spacing-lg);
                border-bottom: 2px solid var(--border-color);
            }

            .content-header h1 {
                color: var(--text-primary);
                font-size: 1.875rem;
                font-weight: 700;
                margin: 0;
                display: flex;
                align-items: center;
                gap: var(--spacing-sm);
            }

            /* Controls Bar */
            .controls-bar {
                background: white;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-sm);
                padding: var(--spacing-lg);
                margin-bottom: var(--spacing-lg);
                display: grid;
                grid-template-columns: 1fr auto;
                gap: var(--spacing-lg);
                align-items: center;
            }

            .filter-controls {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: var(--spacing-md);
            }

            /* Button Styles */
            .btn {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 0.625rem 1.25rem;
                font-weight: 500;
                font-size: 0.875rem;
                border-radius: 8px;
                transition: all 0.2s ease;
                white-space: nowrap;
                min-width: fit-content;
            }

            .btn:hover {
                transform: translateY(-1px);
            }

            .btn ion-icon {
                font-size: 1.1rem;
                flex-shrink: 0;
            }

            .btn-primary {
                background: #2563eb;
                color: white;
                border: none;
            }

            .btn-primary:hover {
                background: #1d4ed8;
            }

            .btn-success {
                background: #22c55e;
                color: white;
                border: none;
            }

            .btn-success:hover {
                background: #16a34a;
            }

            .btn-info {
                background: #3b82f6;
                color: white;
                border: none;
            }

            .btn-info:hover {
                background: #2563eb;
            }

            /* Action Buttons Container */
            .controls-bar > div:last-child {
                display: flex;
                gap: 8px;
                align-items: center;
                flex-wrap: nowrap;
            }

            @media (max-width: 1200px) {
                .controls-bar {
                    grid-template-columns: 1fr;
                }
                
                .controls-bar > div:last-child {
                    justify-content: flex-end;
                }
            }

            @media (max-width: 768px) {
                .controls-bar {
                    padding: var(--spacing-md);
                }
                
                .filter-controls {
                    grid-template-columns: 1fr;
                }
                
                .controls-bar > div:last-child {
                    flex-wrap: wrap;
                    justify-content: center;
                }
                
                .btn {
                    flex: 1;
                    justify-content: center;
                }
            }

            /* Table Styles */
            .table-container {
                background: white;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-sm);
                padding: var(--spacing-lg);
                overflow: hidden;
            }

            .table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
            }

            .table th {
                background-color: #f8fafc;
                color: var(--text-secondary);
                font-weight: 600;
                padding: 1rem;
                text-align: left;
                border-bottom: 2px solid var(--border-color);
                font-size: 0.875rem;
            }

            .table td {
                padding: 1rem;
                border-bottom: 1px solid var(--border-color);
                color: var(--text-secondary);
                font-size: 0.875rem;
            }

            .table tbody tr:hover {
                background-color: #f8fafc;
            }

            /* Status Badges */
            .status-badge {
                display: inline-flex;
                align-items: center;
                padding: 0.25rem 0.75rem;
                border-radius: 9999px;
                font-size: 0.75rem;
                font-weight: 600;
                text-align: center;
                margin: 2px 0;
            }

            .status-expired {
                background: #fee2e2;
                color: #dc2626;
            }

            .status-active {
                background: #dcfce7;
                color: #16a34a;
            }

            .status-warning {
                background: #fef3c7;
                color: #d97706;
            }

            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                backdrop-filter: blur(4px);
            }

            .modal-content {
                background-color: white;
                margin: 5% auto;
                padding: var(--spacing-xl);
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-lg);
                width: 90%;
                max-width: 600px;
                position: relative;
            }

            .modal-content h2 {
                font-size: 1.5rem;
                font-weight: 600;
                margin-bottom: var(--spacing-lg);
                display: flex;
                align-items: center;
                gap: var(--spacing-sm);
            }

            /* Form Styles */
            .form-group {
                margin-bottom: var(--spacing-lg);
            }

            .form-group label {
                display: block;
                margin-bottom: var(--spacing-xs);
                color: var(--text-secondary);
                font-weight: 500;
            }

            .form-control {
                width: 100%;
                padding: 0.625rem 1rem;
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius-md);
                transition: all var(--transition-normal);
                font-size: 0.875rem;
            }

            .form-control:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
                outline: none;
            }

            /* Loading Spinner */
            .loading-spinner {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.8);
                backdrop-filter: blur(4px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            }

            .loader {
                animation: rotate 1s infinite;
                height: 50px;
                width: 50px;
            }

            .loader:before,
            .loader:after {
                border-radius: 50%;
                content: "";
                display: block;
                height: 20px;
                width: 20px;
            }

            .loader:before {
                animation: ball1 1s infinite;
                background-color: #fff;
                box-shadow: 30px 0 0 #ff3d00;
                margin-bottom: 10px;
            }

            .loader:after {
                animation: ball2 1s infinite;
                background-color: #ff3d00;
                box-shadow: 30px 0 0 #fff;
            }

            @keyframes rotate {
                0% { transform: rotate(0deg) scale(0.8) }
                50% { transform: rotate(360deg) scale(1.2) }
                100% { transform: rotate(720deg) scale(0.8) }
            }

            @keyframes ball1 {
                0% {
                    box-shadow: 30px 0 0 #ff3d00;
                }
                50% {
                    box-shadow: 0 0 0 #ff3d00;
                    margin-bottom: 0;
                    transform: translate(15px, 15px);
                }
                100% {
                    box-shadow: 30px 0 0 #ff3d00;
                    margin-bottom: 10px;
                }
            }

            @keyframes ball2 {
                0% {
                    box-shadow: 30px 0 0 #fff;
                }
                50% {
                    box-shadow: 0 0 0 #fff;
                    margin-top: -20px;
                    transform: translate(15px, 15px);
                }
                100% {
                    box-shadow: 30px 0 0 #fff;
                    margin-top: 0;
                }
            }

            /* Pagination */
            .pagination {
                margin-top: var(--spacing-lg);
            }

            .page-link {
                color: var(--primary-color);
                padding: 0.5rem 1rem;
                border: 1px solid var(--border-color);
                margin: 0 0.25rem;
                border-radius: var(--border-radius-md);
                transition: all var(--transition-normal);
            }

            .page-link:hover {
                background-color: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .page-item.active .page-link {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
                color: white;
            }

            /* Responsive Design */
            @media (max-width: 768px) {
                .container {
                    padding: var(--spacing-md);
                }

                .main-content {
                    padding: var(--spacing-lg);
                }

                .controls-bar {
                    grid-template-columns: 1fr;
                }

                .filter-controls {
                    grid-template-columns: 1fr;
                }

                .table-responsive {
                    overflow-x: auto;
                }

                .modal-content {
                    margin: 10% auto;
                    padding: var(--spacing-lg);
                    width: 95%;
                }
            }

            .hero-header {
                background: linear-gradient(120deg, #22c1c3 0%, #29d397 100%);
                border-radius: 2rem;
                box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
                padding: 2.5rem 3rem;
                margin-bottom: 2rem;
                color: #fff;
                position: relative;
                overflow: hidden;
                min-height: 180px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: flex-start;
            }

            .hero-header h1 {
                font-size: 2.5rem;
                font-weight: 800;
                margin-bottom: 0.5rem;
                color: #fff;
                text-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }

            .hero-header p {
                font-size: 1.25rem;
                font-weight: 400;
                color: #e0f7fa;
                margin-bottom: 0;
            }

            @media (max-width: 768px) {
                .hero-header {
                    padding: 1.5rem 1rem;
                    min-height: 120px;
                }
                .hero-header h1 {
                    font-size: 1.5rem;
                }
                .hero-header p {
                    font-size: 1rem;
                }
            }

            .stat-card {
                background: #fff;
                border-radius: 1.25rem;
                box-shadow: 0 2px 12px 0 rgba(31, 38, 135, 0.07);
                padding: 1.25rem 1rem;
                text-align: center;
                transition: box-shadow 0.2s;
                min-height: 110px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            .stat-card:hover {
                box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.13);
            }
            .stat-label {
                font-size: 1rem;
                color: #64748b;
                margin-bottom: 0.25rem;
            }
            .stat-value {
                font-size: 2rem;
                font-weight: 700;
                color: #2563eb;
            }
            .stat-total .stat-value { color: #2563eb; }
            .stat-present .stat-value { color: #22c55e; }
            .stat-absent .stat-value { color: #ef4444; }
            .stat-wfh .stat-value { color: #3b82f6; }
            .stat-late .stat-value { color: #f59e0b; }
            .chart-container {
                background: #fff;
                border-radius: 1.25rem;
                box-shadow: 0 2px 12px 0 rgba(31, 38, 135, 0.07);
                padding: 1.5rem;
                min-height: 320px;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            @media (max-width: 768px) {
                .stat-card { min-height: 80px; padding: 0.75rem 0.5rem; }
                .stat-value { font-size: 1.25rem; }
                .chart-container { padding: 0.5rem; min-height: 200px; }
            }

            .custom-stat-card {
                display: flex;
                align-items: center;
                gap: 16px;
                background: #f8fafc;
                border-radius: 18px;
                box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.10);
                padding: 1.25rem 1rem;
                min-height: 90px;
                transition: box-shadow 0.2s;
                border: none;
                margin-bottom: 0;
            }
            .custom-stat-card:hover {
                box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
                background: #f1f5fe;
            }
            .stat-card-icon {
                background: #2563eb;
                color: #fff;
                border-radius: 12px;
                width: 48px;
                height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 2rem;
                box-shadow: 0 2px 8px 0 rgba(37,99,235,0.10);
            }
            .custom-stat-card .stat-label {
                font-size: 1.05rem;
                color: #334155;
                font-weight: 600;
                margin-bottom: 0.15rem;
                text-align: left;
            }
            .custom-stat-card .stat-value {
                font-size: 2.1rem;
                font-weight: 700;
                color: #1e293b;
                text-align: left;
            }
            @media (max-width: 768px) {
                .custom-stat-card {
                    min-height: 60px;
                    padding: 0.75rem 0.5rem;
                    gap: 10px;
                }
                .stat-card-icon {
                    width: 36px;
                    height: 36px;
                    font-size: 1.3rem;
                }
                .custom-stat-card .stat-value {
                    font-size: 1.2rem;
                }
            }

            .attendance-stats-cards {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 24px;
                margin-bottom: 2rem;
            }

            .attendance-stats-cards .custom-stat-card {
                min-width: 210px;
                max-width: 240px;
                flex: 1 1 210px;
                margin: 0;
                background: #f8fafc;
                border-radius: 18px;
                box-shadow: 0 2px 12px 0 rgba(31, 38, 135, 0.08);
                border: 1px solid #e2e8f0;
                transition: box-shadow 0.18s, transform 0.18s;
                display: flex;
                align-items: center;
                gap: 16px;
                padding: 1.1rem 1rem;
                height: 100px;
            }

            .attendance-stats-cards .custom-stat-card:hover {
                box-shadow: 0 6px 24px 0 rgba(31, 38, 135, 0.16);
                background: #e0e7ff;
                transform: translateY(-2px) scale(1.03);
            }

            .attendance-stats-cards .stat-card-icon {
                width: 52px;
                height: 52px;
                font-size: 2.2rem;
                border-radius: 14px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 1px 6px 0 rgba(37,99,235,0.10);
            }

            .attendance-stats-cards .stat-label {
                font-size: 0.98rem;
                color: #64748b;
                font-weight: 500;
                margin-bottom: 0.18rem;
                text-align: left;
                letter-spacing: 0.01em;
            }

            .attendance-stats-cards .stat-value {
                font-size: 2.2rem;
                font-weight: 800;
                color: #1e293b;
                text-align: left;
                line-height: 1.1;
            }

            @media (max-width: 900px) {
                .attendance-stats-cards {
                    gap: 14px;
                }
                .attendance-stats-cards .custom-stat-card {
                    min-width: 160px;
                    max-width: 100%;
                    height: 80px;
                    padding: 0.7rem 0.5rem;
                }
                .attendance-stats-cards .stat-card-icon {
                    width: 36px;
                    height: 36px;
                    font-size: 1.3rem;
                }
                .attendance-stats-cards .stat-value {
                    font-size: 1.2rem;
                }
            }
            @media (max-width: 600px) {
                .attendance-stats-cards {
                    flex-direction: column;
                    align-items: center;
                    gap: 10px;
                }
                .attendance-stats-cards .custom-stat-card {
                    width: 100%;
                    min-width: 0;
                    max-width: 100%;
                    height: auto;
                    justify-content: flex-start;
                }
            }

            /* Thêm style cho date picker */
            .flatpickr-calendar {
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                font-family: 'Inter', sans-serif;
            }
            .flatpickr-day.selected {
                background: #2563eb;
                border-color: #2563eb;
            }
            .flatpickr-day:hover {
                background: #e0e7ff;
            }
            .flatpickr-current-month {
                padding: 8px 0;
            }
            .flatpickr-months .flatpickr-month {
                height: 40px;
            }
            .flatpickr-weekday {
                font-weight: 600;
                color: #64748b;
            }
            .flatpickr-day {
                border-radius: 4px;
                margin: 2px;
            }
            .flatpickr-day.today {
                border-color: #2563eb;
            }
            .flatpickr-day.today:hover,
            .flatpickr-day.today:focus {
                background: #e0e7ff;
                border-color: #2563eb;
            }

            /* Thêm CSS cho thông báo */
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                background: white;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
            }
            
            .notification-content {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .notification ion-icon {
                font-size: 24px;
            }
            
            .notification.success {
                background: #dcfce7;
                color: #166534;
            }
            
            .notification.error {
                background: #fee2e2;
                color: #991b1b;
            }
            
            .notification.info {
                background: #dbeafe;
                color: #1e40af;
            }
            
            .notification.warning {
                background: #fef3c7;
                color: #92400e;
            }
            
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            /* Unmarked Employees Modal Styles */
            #unmarkedEmployeesModal .modal-content {
                max-width: 900px;
                width: 95%;
                margin: 2% auto;
                background: #fff;
                border-radius: 16px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                padding: 2rem;
                position: relative;
                animation: modalSlideIn 0.3s ease-out;
            }

            #unmarkedEmployeesModal .modal-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid #e2e8f0;
            }

            #unmarkedEmployeesModal .modal-header h2 {
                font-size: 1.5rem;
                font-weight: 700;
                color: #1e293b;
                margin: 0;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            #unmarkedEmployeesModal .modal-header ion-icon {
                font-size: 1.8rem;
                color: #2563eb;
            }

            #unmarkedEmployeesModal .table-container {
                background: #f8fafc;
                border-radius: 12px;
                padding: 1rem;
                margin-bottom: 1.5rem;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }

            #unmarkedEmployeesModal .table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
            }

            #unmarkedEmployeesModal .table th {
                background: #f1f5f9;
                color: #475569;
                font-weight: 600;
                padding: 1rem;
                text-align: left;
                font-size: 0.875rem;
                border-bottom: 2px solid #e2e8f0;
            }

            #unmarkedEmployeesModal .table td {
                padding: 1rem;
                border-bottom: 1px solid #e2e8f0;
                color: #475569;
                font-size: 0.875rem;
                vertical-align: middle;
            }

            #unmarkedEmployeesModal .table tbody tr:hover {
                background-color: #f1f5f9;
            }

            #unmarkedEmployeesModal .status-badge {
                display: inline-flex;
                align-items: center;
                padding: 0.35rem 0.75rem;
                border-radius: 9999px;
                font-size: 0.75rem;
                font-weight: 600;
                text-align: center;
            }

            #unmarkedEmployeesModal .status-active {
                background: #dcfce7;
                color: #166534;
            }

            #unmarkedEmployeesModal .status-warning {
                background: #fef3c7;
                color: #92400e;
            }

            #unmarkedEmployeesModal .btn-mark-attendance {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 0.5rem 1rem;
                background: #2563eb;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 0.875rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            #unmarkedEmployeesModal .btn-mark-attendance:hover {
                background: #1d4ed8;
                transform: translateY(-1px);
            }

            #unmarkedEmployeesModal .btn-mark-attendance ion-icon {
                font-size: 1.1rem;
            }

            #unmarkedEmployeesModal .modal-footer {
                display: flex;
                justify-content: flex-end;
                gap: 12px;
                margin-top: 1.5rem;
                padding-top: 1rem;
                border-top: 2px solid #e2e8f0;
            }

            #unmarkedEmployeesModal .btn-close {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 0.625rem 1.25rem;
                background: #f1f5f9;
                color: #475569;
                border: none;
                border-radius: 8px;
                font-size: 0.875rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            #unmarkedEmployeesModal .btn-close:hover {
                background: #e2e8f0;
            }

            @keyframes modalSlideIn {
                from {
                    transform: translateY(-20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            @media (max-width: 768px) {
                #unmarkedEmployeesModal .modal-content {
                    margin: 5% auto;
                    padding: 1.5rem;
                }
                
                #unmarkedEmployeesModal .table-container {
                    padding: 0.5rem;
                }
                
                #unmarkedEmployeesModal .table th,
                #unmarkedEmployeesModal .table td {
                    padding: 0.75rem;
                }
                
                #unmarkedEmployeesModal .btn-mark-attendance {
                    padding: 0.4rem 0.75rem;
                }
            }
        </style>

        <!-- Scripts -->
        <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@latest/dist/ionic/ionic.esm.js"></script>
        <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@latest/dist/ionic/ionic.js"></script>
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vi.js"></script>
        <script src="css/common.css"></script>
        <script src="js/auth_utils.js"></script>
        <script src="js/api_service.js"></script>
        <script src="js/attendance-display.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <div class="container">
            <main class="main-content">
                <!-- Nút quay lại Dashboard -->
                <a href="../dashboard_admin_V1.php" class="btn btn-outline-primary mb-3 d-inline-flex align-items-center" style="font-weight:600;font-size:1rem;gap:8px;">
                    <i class="fa fa-arrow-left"></i> Quay lại Dashboard
                </a>
                <div class="hero-header mb-4">
                    <h1>Quản lý chấm công</h1>
                    <p>Quản lý thông tin chấm công của nhân viên</p>
                </div>
                <!-- Card thống kê tổng quan -->
                <div class="attendance-stats-cards mb-4" id="attendanceStatsCards">
                    <div class="custom-stat-card stat-total">
                        <div class="stat-card-icon">
                            <ion-icon name="calendar-clear-outline"></ion-icon>
                        </div>
                        <div>
                            <div class="stat-label">Tổng lượt chấm công</div>
                            <div class="stat-value" id="statTotal">0</div>
                        </div>
                    </div>
                    <div class="custom-stat-card stat-present">
                        <div class="stat-card-icon" style="background:#22c55e;">
                            <ion-icon name="calendar-checkmark-outline"></ion-icon>
                        </div>
                        <div>
                            <div class="stat-label">Có mặt (P)</div>
                            <div class="stat-value" id="statPresent">0</div>
                        </div>
                    </div>
                    <div class="custom-stat-card stat-absent">
                        <div class="stat-card-icon" style="background:#ef4444;">
                            <ion-icon name="calendar-outline"></ion-icon>
                        </div>
                        <div>
                            <div class="stat-label">Vắng mặt (A)</div>
                            <div class="stat-value" id="statAbsent">0</div>
                        </div>
                    </div>
                    <div class="custom-stat-card stat-wfh">
                        <div class="stat-card-icon" style="background:#3b82f6;">
                            <ion-icon name="home-outline"></ion-icon>
                        </div>
                        <div>
                            <div class="stat-label">Làm từ xa (WFH)</div>
                            <div class="stat-value" id="statWFH">0</div>
                        </div>
                    </div>
                    <div class="custom-stat-card stat-late">
                        <div class="stat-card-icon" style="background:#f59e0b;">
                            <ion-icon name="time-outline"></ion-icon>
                        </div>
                        <div>
                            <div class="stat-label">Đi muộn (L)</div>
                            <div class="stat-value" id="statLate">0</div>
                        </div>
                    </div>
                </div>
                <!-- Controls Bar -->
                <div class="controls-bar">
                    <div class="filter-controls">
                        <input type="text" id="searchCode" class="form-control" placeholder="Tìm mã nhân viên...">
                        <input type="text" id="searchName" class="form-control" placeholder="Tìm tên nhân viên...">
                        <input type="date" id="dateFilter" class="form-control">
                        <select id="statusFilter" class="form-control">
                            <option value="">Tất cả trạng thái</option>
                            <option value="P">Có mặt (P)</option>
                            <option value="A">Vắng mặt (A)</option>
                            <option value="L">Nghỉ phép (L)</option>
                            <option value="WFH">Làm việc từ xa (WFH)</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" id="addAttendanceButton">
                            <ion-icon name="add-circle-outline"></ion-icon>
                            Thêm chấm công
                        </button>
                        <button class="btn btn-success" id="exportExcelButton">
                            <ion-icon name="download-outline"></ion-icon>
                            Xuất Excel
                        </button>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Mã nhân viên</th>
                                    <th>Họ tên</th>
                                    <th>Ngày</th>
                                    <th>Giờ vào</th>
                                    <th>Giờ ra</th>
                                    <th>Trạng thái</th>
                                    <th>Ghi chú</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceList">
                                <!-- Dữ liệu sẽ được thêm vào đây bằng JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <nav aria-label="Attendance pagination" style="margin-top:16px;">
                        <ul class="pagination justify-content-center" id="attendancePagination"></ul>
                    </nav>
                </div>
            </main>
        </div>

        <!-- Unmarked Employees Modal -->
        <div id="unmarkedEmployeesModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <ion-icon name="people-outline"></ion-icon>
                    <h2>Danh sách nhân viên chưa chấm công</h2>
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Mã nhân viên</th>
                                    <th>Họ tên</th>
                                    <th>Trạng thái</th>
                                    <th>Phòng ban</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="unmarkedEmployeesList">
                                <!-- Dữ liệu sẽ được thêm vào đây bằng JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-close" onclick="closeUnmarkedModal()">
                        <ion-icon name="close-outline"></ion-icon>
                        Đóng
                    </button>
                </div>
            </div>
        </div>

        <!-- Delete Modal -->
        <div id="deleteModal" class="modal">
            <div class="modal-content">
                <h2>
                    <ion-icon name="warning-outline"></ion-icon>
                    Xác nhận xóa
                </h2>
                <p>Bạn có chắc chắn muốn xóa bản ghi chấm công này?</p>
                <div class="form-actions">
                    <button id="confirmDeleteButton" class="btn btn-danger">
                        <ion-icon name="trash-outline"></ion-icon>
                        Xóa
                    </button>
                    <button id="cancelDeleteButton" class="btn btn-secondary">
                        <ion-icon name="close-outline"></ion-icon>
                        Hủy
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <h2>
                    <ion-icon name="create-outline"></ion-icon>
                    <span id="modalTitle">Thêm chấm công mới</span>
                </h2>
                <form id="editForm" onsubmit="event.preventDefault(); updateAttendance();">
                    <input type="hidden" id="attendanceId" name="attendanceId">
                    <div class="form-group">
                        <label for="employeeId">Mã nhân viên:</label>
                        <select id="employeeId" name="employeeId" class="form-control" required>
                            <option value="">Chọn nhân viên...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="attendanceDate">Ngày điểm danh:</label>
                        <input type="text" id="attendanceDate" name="attendanceDate" class="form-control" required placeholder="DD/MM/YYYY">
                    </div>
                    <div class="form-group">
                        <label for="attendanceSymbol">Ký hiệu:</label>
                        <select id="attendanceSymbol" name="attendanceSymbol" class="form-control" required>
                            <option value="P">P - Có mặt</option>
                            <option value="A">A - Vắng mặt</option>
                            <option value="L">L - Đi muộn</option>
                            <option value="WFH">WFH - Làm việc từ xa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notes">Ghi chú:</label>
                        <textarea id="notes" name="notes" class="form-control"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <ion-icon name="save-outline"></ion-icon>
                            Lưu thay đổi
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">
                            <ion-icon name="close-outline"></ion-icon>
                            Hủy
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner" style="display: none;">
            <div class="loader"></div>
        </div>

        <script>
        let currentAttendanceData = [];
        let deleteAttendanceId = null;
        let currentPage = 1;
        const pageSize = 10;
        let filterCode = '';
        let filterName = '';
        let filterDate = '';
        let filterStatus = '';

        // Khai báo biến datePicker ở global scope
        let datePicker;

        // Hàm khởi tạo datePicker
        function initializeDatePicker() {
            datePicker = flatpickr("#attendanceDate", {
                locale: "vi",
                dateFormat: "d/m/Y",
                allowInput: true,
                altInput: true,
                altFormat: "d/m/Y",
                theme: "material_blue",
                disableMobile: "true",
                onChange: function(selectedDates, dateStr) {
                    // Khi ngày thay đổi, cập nhật lại danh sách nhân viên
                    if (selectedDates.length > 0) {
                        loadEmployeeList();
                    }
                }
            });
        }

        async function loadAttendanceData() {
            try {
                // Hiển thị loading spinner
                document.getElementById('loadingSpinner').style.display = 'flex';
                
                const baseUrl = window.location.origin;
                console.log('Attempting to connect to:', `${baseUrl}/qlnhansu_V3/backend/src/api/v1/attendance.php?action=getAll`);
                
                const response = await fetch(`${baseUrl}/qlnhansu_V3/backend/src/api/v1/attendance.php?action=getAll`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('API Response:', data);

                if (data.success && Array.isArray(data.data)) {
                    currentAttendanceData = data.data;
                    currentPage = 1;
                    updateAttendanceTable();
                    updateStatsAndChart(currentAttendanceData);
                } else {
                    throw new Error(data.message || 'Lỗi khi tải dữ liệu chấm công');
                }
            } catch (error) {
                console.error('Error details:', error);
                console.error('Error stack:', error.stack);
                showNotification('error', 'Lỗi kết nối server: ' + error.message);
            } finally {
                // Ẩn loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        function displayAttendanceData(attendanceData) {
            const attendanceList = document.getElementById('attendanceList');
            attendanceList.innerHTML = '';
            
            if (!Array.isArray(attendanceData) || attendanceData.length === 0) {
                attendanceList.innerHTML = '<tr><td colspan="8" class="text-center">Không có dữ liệu</td></tr>';
                return;
            }

            attendanceData.forEach(record => {
                const row = document.createElement('tr');
                
                // Format date from YYYY-MM-DD to DD/MM/YYYY
                const formattedDate = record.attendance_date ? 
                    new Date(record.attendance_date).toLocaleDateString('vi-VN', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    }) : '-';

                // Xác định trạng thái và class
                let statusText = '';
                let statusClass = 'status-badge';
                
                switch(record.attendance_symbol) {
                    case 'P':
                        statusText = 'Có mặt';
                    statusClass += ' status-active';
                        break;
                    case 'A':
                        statusText = 'Vắng mặt';
                        statusClass += ' status-expired';
                        break;
                    case 'WFH':
                        statusText = 'Làm từ xa';
                    statusClass += ' status-warning';
                        break;
                    case 'L':
                        statusText = 'Đi muộn';
                        statusClass += ' status-warning';
                        break;
                    default:
                    statusText = record.attendance_symbol || '-';
                }

                row.innerHTML = `
                    <td>${record.employee_code || '-'}</td>
                    <td>${record.employee_name || '-'}</td>
                    <td>${formattedDate}</td>
                    <td>${record.check_in_time || '-'}</td>
                    <td>${record.check_out_time || '-'}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>${record.notes || '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editAttendance(${record.attendance_id})">
                            <ion-icon name="create-outline"></ion-icon>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="confirmDelete(${record.attendance_id})">
                            <ion-icon name="trash-outline"></ion-icon>
                        </button>
                    </td>
                `;
                attendanceList.appendChild(row);
            });
        }

        function editAttendance(id) {
            const record = currentAttendanceData.find(r => r.attendance_id == id);
            if (!record) {
                alert('Không tìm thấy thông tin chấm công');
                return;
            }

            // Load danh sách nhân viên trước
            loadEmployeeList().then(() => {
                try {
            document.getElementById('attendanceId').value = record.attendance_id;
            document.getElementById('employeeId').value = record.employee_id;
                    document.getElementById('employeeId').disabled = true;
                    document.getElementById('modalTitle').textContent = 'Sửa thông tin điểm danh';
                    
                    // Set ngày cho date picker
                    if (record.attendance_date) {
                        datePicker.setDate(record.attendance_date);
                    } else {
                        datePicker.clear();
                    }
                    
                    document.getElementById('attendanceSymbol').value = record.attendance_symbol || 'P';
            document.getElementById('notes').value = record.notes || '';
            document.getElementById('editModal').style.display = 'block';
                } catch (error) {
                    console.error('Error in editAttendance:', error);
                    alert('Lỗi khi tải thông tin chấm công');
                }
            }).catch(error => {
                console.error('Error loading employee list:', error);
                alert('Lỗi khi tải danh sách nhân viên');
            });
        }

        function confirmDelete(id) {
            deleteAttendanceId = id;
            document.getElementById('deleteModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('deleteModal').style.display = 'none';
            document.getElementById('employeeId').disabled = false;
            // Reset date picker
            datePicker.clear();
            // Reset form
            document.getElementById('editForm').reset();
        }

        document.getElementById('cancelDeleteButton').onclick = closeModal;
        document.getElementById('confirmDeleteButton').onclick = async function() {
            if (!deleteAttendanceId) return;
            
            try {
                // Hiển thị loading spinner
                document.getElementById('loadingSpinner').style.display = 'flex';
                
                const response = await fetch(`/qlnhansu_V3/backend/src/api/v1/attendance.php?action=delete&id=${deleteAttendanceId}`);
                const data = await response.json();
                
                if (data.success) {
                    showNotification('success', 'Xóa điểm danh thành công');
                    await loadAttendanceData();
                } else {
                    showNotification('error', 'Xóa thất bại: ' + (data.message || 'Lỗi không xác định'));
                }
            } catch (error) {
                console.error('Error deleting attendance:', error);
                showNotification('error', 'Lỗi khi xóa điểm danh');
            } finally {
                // Ẩn loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
                closeModal();
            }
        };

        document.getElementById('addAttendanceButton').onclick = function() {
            // Reset form
            document.getElementById('editForm').reset();
            document.getElementById('attendanceId').value = '';
            document.getElementById('employeeId').disabled = false;
            document.getElementById('modalTitle').textContent = 'Thêm chấm công mới';
            
            // Set ngày hiện tại cho date picker
            datePicker.setDate(new Date());
            
            // Load danh sách nhân viên chưa chấm công
            loadEmployeeList();
            
            document.getElementById('editModal').style.display = 'block';
        };

        document.getElementById('exportExcelButton').onclick = function() {
            if (!currentAttendanceData || currentAttendanceData.length === 0) {
                alert('Không có dữ liệu để xuất!');
                return;
            }
            // Chuyển đổi dữ liệu sang mảng object cho Excel
            const exportData = currentAttendanceData.map(record => ({
                'Mã nhân viên': record.employee_code || '-',
                'Họ tên': record.employee_name || '-',
                'Ngày': record.attendance_date,
                'Giờ vào': record.check_in_time || '-',
                'Giờ ra': record.check_out_time || '-',
                'Trạng thái': (record.attendance_symbol === 'A' ? 'Hết hạn' : (record.attendance_symbol === 'P' ? 'Còn hiệu lực' : (record.status_text || record.attendance_symbol || '-'))),
                'Ghi chú': record.notes || '-'
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ChamCong');
            XLSX.writeFile(wb, 'danh_sach_cham_cong.xlsx');
        };

        document.getElementById('searchCode').oninput = function(e) {
            filterCode = e.target.value.trim().toLowerCase();
            currentPage = 1;
            updateAttendanceTable();
        };
        document.getElementById('searchName').oninput = function(e) {
            filterName = e.target.value.trim().toLowerCase();
            currentPage = 1;
            updateAttendanceTable();
        };
        document.getElementById('dateFilter').onchange = function(e) {
            filterDate = e.target.value;
            currentPage = 1;
            updateAttendanceTable();
        };
        document.getElementById('statusFilter').onchange = function(e) {
            filterStatus = e.target.value;
            currentPage = 1;
            updateAttendanceTable();
        };

        function updateAttendanceTable() {
            let data = currentAttendanceData.slice();
            // Lọc theo mã nhân viên
            if (filterCode) {
                data = data.filter(r => (r.employee_code || '').toLowerCase().includes(filterCode));
            }
            // Lọc theo tên nhân viên
            if (filterName) {
                data = data.filter(r => (r.employee_name || '').toLowerCase().includes(filterName));
            }
            // Lọc theo ngày
            if (filterDate) {
                data = data.filter(r => r.attendance_date === filterDate);
            }
            // Lọc theo trạng thái
            if (filterStatus) {
                data = data.filter(r => r.attendance_symbol === filterStatus);
            }
            // Sắp xếp và phân trang như cũ
            data.sort((a, b) => {
                const dateA = new Date(a.attendance_date);
                const dateB = new Date(b.attendance_date);
                if (dateA.getTime() !== dateB.getTime()) return dateB - dateA;
                const getStatusPriority = (r) => {
                    if (r.attendance_symbol === 'A' || r.status_text === 'Hết hạn') return 1;
                    if (r.status_text === 'Sắp hết hạn') return 2;
                    if (r.attendance_symbol === 'P' || r.status_text === 'Còn hiệu lực') return 3;
                    return 4;
                };
                const priA = getStatusPriority(a);
                const priB = getStatusPriority(b);
                if (priA !== priB) return priA - priB;
                return a.employee_name.localeCompare(b.employee_name, 'vi', {sensitivity: 'base'});
            });
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            displayAttendanceData(data.slice(start, end));
            renderPagination(data.length);
        }

        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / pageSize);
            const pagination = document.getElementById('attendancePagination');
            pagination.innerHTML = '';
            if (totalPages <= 1) return;
            // Previous
            const prevLi = document.createElement('li');
            prevLi.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
            prevLi.innerHTML = `<a class="page-link" href="#">&laquo;</a>`;
            prevLi.onclick = function(e) { e.preventDefault(); if (currentPage > 1) { currentPage--; updateAttendanceTable(); } };
            pagination.appendChild(prevLi);
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = 'page-item' + (i === currentPage ? ' active' : '');
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.onclick = function(e) { e.preventDefault(); if (currentPage !== i) { currentPage = i; updateAttendanceTable(); } };
                pagination.appendChild(li);
            }
            // Next
            const nextLi = document.createElement('li');
            nextLi.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
            nextLi.innerHTML = `<a class="page-link" href="#">&raquo;</a>`;
            nextLi.onclick = function(e) { e.preventDefault(); if (currentPage < totalPages) { currentPage++; updateAttendanceTable(); } };
            pagination.appendChild(nextLi);
        }

        function updateStatsAndChart(attendanceData) {
            if (!Array.isArray(attendanceData)) {
                console.error('Invalid attendance data:', attendanceData);
                return;
            }

            // Đếm số lượng theo trạng thái
            let present = 0, absent = 0, wfh = 0, late = 0;
            
                attendanceData.forEach(r => {
                    if (r && r.attendance_symbol) {
                    switch(r.attendance_symbol) {
                        case 'P': present++; break;
                        case 'A': absent++; break;
                        case 'WFH': wfh++; break;
                        case 'L': late++; break;
                    }
                }
            });

            const total = present + absent + wfh + late;
            
            // Cập nhật số liệu thống kê
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPresent').textContent = present;
            document.getElementById('statAbsent').textContent = absent;
            document.getElementById('statWFH').textContent = wfh;
            document.getElementById('statLate').textContent = late;

            // Kiểm tra và vẽ biểu đồ nếu canvas tồn tại
            const canvas = document.getElementById('attendancePieChart');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                if (window.attendancePieChart) {
                    window.attendancePieChart.destroy();
                }
            window.attendancePieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Có mặt (P)', 'Vắng mặt (A)', 'Làm từ xa (WFH)', 'Đi muộn (L)'],
                    datasets: [{
                        data: [present, absent, wfh, late],
                        backgroundColor: [
                            '#22c55e', '#ef4444', '#3b82f6', '#f59e0b'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Tỷ lệ trạng thái chấm công' }
                    }
                }
            });
            }
        }

        // Thêm các hàm format date
        function formatDateForDisplay(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function formatDateForInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }

        // Cập nhật hàm loadEmployeeList
        async function loadEmployeeList() {
            try {
                // Kiểm tra nếu datePicker chưa được khởi tạo
                if (!datePicker) {
                    console.error('DatePicker chưa được khởi tạo');
                    return;
                }

                // Lấy ngày hiện tại từ date picker hoặc ngày mặc định
                const selectedDate = datePicker.selectedDates[0] || new Date();
                const formattedDate = selectedDate.toISOString().split('T')[0];
                
                // Hiển thị loading spinner
                document.getElementById('loadingSpinner').style.display = 'flex';
                
                const response = await fetch(`/qlnhansu_V3/backend/src/api/v1/attendance.php?action=getUnmarkedEmployees&date=${formattedDate}`);
                const data = await response.json();
                
                if (data.success && Array.isArray(data.data)) {
                    const select = document.getElementById('employeeId');
                    select.innerHTML = '<option value="">Chọn nhân viên...</option>';
                    
                    if (data.data.length === 0) {
                        const option = document.createElement('option');
                        option.disabled = true;
                        option.textContent = 'Tất cả nhân viên đã được chấm công cho ngày này';
                        select.appendChild(option);
                        select.disabled = true;
                        
                        // Hiển thị thông báo
                        showNotification('success', `Tất cả nhân viên đã được chấm công cho ngày ${formatDateForDisplay(formattedDate)}`);
                    } else {
                        select.disabled = false;
                        
                        // Nhóm nhân viên theo trạng thái
                        const groupedEmployees = data.data.reduce((acc, employee) => {
                            const status = employee.employee_status || 'Không xác định';
                            if (!acc[status]) {
                                acc[status] = [];
                            }
                            acc[status].push(employee);
                            return acc;
                        }, {});
                        
                        // Tạo optgroup cho từng trạng thái
                        Object.entries(groupedEmployees).forEach(([status, employees]) => {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = status;
                            
                            employees.forEach(employee => {
                                const option = document.createElement('option');
                                option.value = employee.employee_id;
                                option.textContent = `${employee.employee_code} - ${employee.employee_name}`;
                                optgroup.appendChild(option);
                            });
                            
                            select.appendChild(optgroup);
                        });
                        
                        // Hiển thị thông báo số lượng nhân viên chưa chấm công
                        showNotification('info', `Có ${data.total_unmarked} nhân viên chưa được chấm công cho ngày ${formatDateForDisplay(formattedDate)}`);
                    }
                }
            } catch (error) {
                console.error('Error loading employee list:', error);
                showNotification('error', 'Lỗi khi tải danh sách nhân viên');
            } finally {
                // Ẩn loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        // Thêm hàm hiển thị thông báo
        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <ion-icon name="${getIconForType(type)}"></ion-icon>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Tự động ẩn sau 5 giây
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Hàm lấy icon tương ứng với loại thông báo
        function getIconForType(type) {
            switch(type) {
                case 'success':
                    return 'checkmark-circle-outline';
                case 'error':
                    return 'alert-circle-outline';
                case 'info':
                    return 'information-circle-outline';
                case 'warning':
                    return 'warning-outline';
                default:
                    return 'notifications-outline';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Khởi tạo datePicker trước
            initializeDatePicker();
            
            // Sau đó mới load dữ liệu
            loadAttendanceData();
            loadEmployeeList();
            loadEmployeeCount();
            
            // Thêm sự kiện cho nút thêm mới
            document.getElementById('addAttendanceButton').onclick = function() {
                // Reset form
                document.getElementById('editForm').reset();
                document.getElementById('attendanceId').value = '';
                document.getElementById('employeeId').disabled = false;
                document.getElementById('modalTitle').textContent = 'Thêm chấm công mới';
                
                // Set ngày hiện tại cho date picker
                datePicker.setDate(new Date());
                
                // Load danh sách nhân viên chưa chấm công
                loadEmployeeList();
                
                document.getElementById('editModal').style.display = 'block';
            };
        });

        // Thêm hàm mới
        async function loadEmployeeCount() {
            try {
                const response = await fetch('/qlnhansu_V3/backend/src/api/v1/attendance.php?action=getEmployeeCount');
                const data = await response.json();
                
                if (data.success) {
                    const totalEmployees = data.data.total_employees;
                    // Thêm thông tin vào hero header
                    const heroHeader = document.querySelector('.hero-header p');
                    heroHeader.innerHTML = `Quản lý thông tin chấm công của ${totalEmployees} nhân viên`;
                }
            } catch (error) {
                console.error('Error loading employee count:', error);
            }
        }

        // Thêm hàm mới để hiển thị modal danh sách nhân viên chưa chấm công
        function showUnmarkedEmployeesModal() {
            document.getElementById('unmarkedEmployeesModal').style.display = 'block';
            loadUnmarkedEmployeesList();
        }

        // Thêm hàm đóng modal
        function closeUnmarkedModal() {
            document.getElementById('unmarkedEmployeesModal').style.display = 'none';
        }

        // Thêm hàm tải danh sách nhân viên chưa chấm công
        async function loadUnmarkedEmployeesList() {
            try {
                // Hiển thị loading spinner
                document.getElementById('loadingSpinner').style.display = 'flex';
                
                const selectedDate = datePicker.selectedDates[0] || new Date();
                const formattedDate = selectedDate.toISOString().split('T')[0];
                
                const response = await fetch(`/qlnhansu_V3/backend/src/api/v1/attendance.php?action=getUnmarkedEmployees&date=${formattedDate}`);
                const data = await response.json();
                
                if (data.success && Array.isArray(data.data)) {
                    const tbody = document.getElementById('unmarkedEmployeesList');
                    tbody.innerHTML = '';
                    
                    if (data.data.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center" style="padding: 2rem; color: #64748b;">
                                    <ion-icon name="checkmark-circle-outline" style="font-size: 2rem; color: #22c55e; display: block; margin-bottom: 0.5rem;"></ion-icon>
                                    Tất cả nhân viên đã được chấm công cho ngày ${formatDateForDisplay(formattedDate)}
                                </td>
                            </tr>`;
                    } else {
                        data.data.forEach(employee => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>
                                    <span style="font-weight: 500; color: #1e293b;">${employee.employee_code || '-'}</span>
                                </td>
                                <td>
                                    <div style="font-weight: 500; color: #1e293b;">${employee.employee_name || '-'}</div>
                                </td>
                                <td>
                                    <span class="status-badge ${employee.employee_status === 'Đang làm việc' ? 'status-active' : 'status-warning'}">
                                        ${employee.employee_status || 'Không xác định'}
                                    </span>
                                </td>
                                <td>
                                    <span style="color: #475569;">${employee.department_name || '-'}</span>
                                </td>
                                <td>
                                    <button class="btn-mark-attendance" onclick="addAttendanceForEmployee(${employee.employee_id})">
                                        <ion-icon name="add-circle-outline"></ion-icon>
                                        Chấm công
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading unmarked employees list:', error);
                showNotification('error', 'Lỗi khi tải danh sách nhân viên chưa chấm công');
            } finally {
                // Ẩn loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        // Thêm hàm chấm công cho nhân viên
        function addAttendanceForEmployee(employeeId) {
            // Reset form
            document.getElementById('editForm').reset();
            document.getElementById('attendanceId').value = '';
            document.getElementById('employeeId').value = employeeId;
            document.getElementById('employeeId').disabled = true;
            document.getElementById('modalTitle').textContent = 'Thêm chấm công mới';
            
            // Set ngày hiện tại cho date picker
            datePicker.setDate(new Date());
            
            // Đóng modal danh sách nhân viên chưa chấm công
            closeUnmarkedModal();
            
            // Mở modal thêm chấm công
            document.getElementById('editModal').style.display = 'block';
        }

        // Thêm nút vào controls bar
        document.querySelector('.controls-bar .filter-controls').insertAdjacentHTML('beforeend', `
            <button class="btn btn-info" onclick="showUnmarkedEmployeesModal()">
                <ion-icon name="people-outline"></ion-icon>
                Xem nhân viên chưa chấm công
            </button>
        `);

        async function addAttendance() {
            try {
                // Hiển thị loading spinner
                document.getElementById('loadingSpinner').style.display = 'flex';

                // Lấy ngày từ date picker và chuyển đổi định dạng
                const selectedDate = datePicker.selectedDates[0];
                if (!selectedDate) {
                    showNotification('error', 'Vui lòng chọn ngày chấm công');
                    return;
                }

                // Chuyển đổi ngày sang định dạng YYYY-MM-DD
                const formattedDate = selectedDate.toISOString().split('T')[0];

                const formData = {
                    employee_id: document.getElementById('employeeId').value,
                    attendance_date: formattedDate,
                    attendance_symbol: document.getElementById('attendanceSymbol').value,
                    notes: document.getElementById('notes').value
                };

                const response = await fetch('/qlnhansu_V3/backend/src/api/v1/attendance.php?action=add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                // Đọc response dưới dạng text trước
                const responseText = await response.text();
                let data;
                
                try {
                    // Thử parse JSON
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('Invalid JSON response:', responseText);
                    throw new Error('Server trả về dữ liệu không hợp lệ');
                }

                if (data.success) {
                    showNotification('success', 'Thêm chấm công thành công');
                    closeModal();
                    await loadAttendanceData();
                } else {
                    showNotification('error', data.message || 'Có lỗi xảy ra');
                }
            } catch (error) {
                console.error('Error adding attendance:', error);
                showNotification('error', 'Lỗi khi thêm chấm công: ' + error.message);
            } finally {
                // Ẩn loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        async function updateAttendance() {
            try {
                // Hiển thị loading spinner
                document.getElementById('loadingSpinner').style.display = 'flex';

                // Lấy ngày từ date picker và chuyển đổi định dạng
                const selectedDate = datePicker.selectedDates[0];
                if (!selectedDate) {
                    showNotification('error', 'Vui lòng chọn ngày chấm công');
                    return;
                }

                // Chuyển đổi ngày sang định dạng YYYY-MM-DD
                const formattedDate = selectedDate.toISOString().split('T')[0];

                const formData = {
                    attendance_id: document.getElementById('attendanceId').value,
                    employee_id: document.getElementById('employeeId').value,
                    attendance_date: formattedDate,
                    attendance_symbol: document.getElementById('attendanceSymbol').value,
                    notes: document.getElementById('notes').value
                };

                const response = await fetch('/qlnhansu_V3/backend/src/api/v1/attendance.php?action=update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                // Đọc response dưới dạng text trước
                const responseText = await response.text();
                let data;
                
                try {
                    // Thử parse JSON
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('Invalid JSON response:', responseText);
                    throw new Error('Server trả về dữ liệu không hợp lệ');
                }

                if (data.success) {
                    showNotification('success', 'Cập nhật chấm công thành công');
                    closeModal();
                    await loadAttendanceData();
                } else {
                    showNotification('error', data.message || 'Có lỗi xảy ra');
                }
            } catch (error) {
                console.error('Error updating attendance:', error);
                showNotification('error', 'Lỗi khi cập nhật thông tin chấm công: ' + error.message);
            } finally {
                // Ẩn loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        // Cập nhật form submit handler
        document.getElementById('editForm').onsubmit = function(event) {
            event.preventDefault();
            const attendanceId = document.getElementById('attendanceId').value;
            if (attendanceId) {
                updateAttendance();
            } else {
                addAttendance();
            }
        };
        </script>
    </body>
</html>
