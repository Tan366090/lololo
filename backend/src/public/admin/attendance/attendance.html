<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta
            http-equiv="Content-Security-Policy"
            content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com http://localhost:4000 http://localhost; object-src 'none';"
        />
        <title>Chấm công hằng ngày - VNPT</title>
        
        <!-- External CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        
        <!-- Internal CSS -->
        <link rel="stylesheet" href="css/attendance.css" />
        <link rel="stylesheet" href="/assets/css/notifications.css">
        <link rel="stylesheet" href="/assets/css/loading.css">
        <link rel="stylesheet" href="/assets/css/style.css">
        <link rel="stylesheet" href="css/common.css">
        
        <style>
            :root {
                /* Color Variables */
                --primary-color: #2563eb;
                --primary-hover: #1d4ed8;
                --secondary-color: #64748b;
                --success-color: #22c55e;
                --danger-color: #ef4444;
                --warning-color: #f59e0b;
                --info-color: #3b82f6;
                --light-color: #f8fafc;
                --dark-color: #1e293b;
                --border-color: #e2e8f0;
                --text-primary: #1e293b;
                --text-secondary: #475569;
                
                /* Spacing Variables */
                --spacing-xs: 0.25rem;
                --spacing-sm: 0.5rem;
                --spacing-md: 1rem;
                --spacing-lg: 1.5rem;
                --spacing-xl: 2rem;
                
                /* Border Radius */
                --border-radius-sm: 0.375rem;
                --border-radius-md: 0.5rem;
                --border-radius-lg: 0.75rem;
                
                /* Shadows */
                --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
                --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
                --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
                
                /* Transitions */
                --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
                --transition-normal: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* Base Styles */
            body {
                font-family: 'Inter', system-ui, -apple-system, sans-serif;
                background-color: #f1f5f9;
                color: var(--text-primary);
                line-height: 1.6;
            }

            /* Layout */
            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: var(--spacing-lg);
            }

            .main-content {
                background: white;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-md);
                padding: var(--spacing-xl);
                min-height: calc(100vh - 40px);
            }

            /* Navigation */
            .attendance-nav {
                background: white;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-sm);
                padding: var(--spacing-lg);
                margin-bottom: var(--spacing-lg);
            }

            .nav-buttons {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: var(--spacing-md);
            }

            .nav-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: var(--spacing-sm);
                padding: var(--spacing-md) var(--spacing-lg);
                background-color: var(--light-color);
                color: var(--text-secondary);
                border-radius: var(--border-radius-md);
                text-decoration: none;
                font-weight: 500;
                transition: all var(--transition-normal);
                border: 1px solid var(--border-color);
            }

            .nav-btn:hover {
                background-color: var(--primary-color);
                color: white;
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

            .nav-btn ion-icon {
                font-size: 1.2rem;
            }

            /* Header */
            .content-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: var(--spacing-xl);
                padding-bottom: var(--spacing-lg);
                border-bottom: 2px solid var(--border-color);
            }

            .content-header h1 {
                color: var(--text-primary);
                font-size: 1.875rem;
                font-weight: 700;
                margin: 0;
                display: flex;
                align-items: center;
                gap: var(--spacing-sm);
            }

            /* Controls Bar */
            .controls-bar {
                background: white;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-sm);
                padding: var(--spacing-lg);
                margin-bottom: var(--spacing-lg);
                display: grid;
                grid-template-columns: 1fr auto;
                gap: var(--spacing-lg);
                align-items: center;
            }

            .filter-controls {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: var(--spacing-md);
            }

            /* Table Styles */
            .table-container {
                background: white;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-sm);
                padding: var(--spacing-lg);
                overflow: hidden;
            }

            .table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
            }

            .table th {
                background-color: #f8fafc;
                color: var(--text-secondary);
                font-weight: 600;
                padding: 1rem;
                text-align: left;
                border-bottom: 2px solid var(--border-color);
                font-size: 0.875rem;
            }

            .table td {
                padding: 1rem;
                border-bottom: 1px solid var(--border-color);
                color: var(--text-secondary);
                font-size: 0.875rem;
            }

            .table tbody tr:hover {
                background-color: #f8fafc;
            }

            /* Status Badges */
            .status-badge {
                display: inline-flex;
                align-items: center;
                padding: 0.25rem 0.75rem;
                border-radius: 9999px;
                font-size: 0.75rem;
                font-weight: 600;
                text-align: center;
                margin: 2px 0;
            }

            .status-expired {
                background: #fee2e2;
                color: #dc2626;
            }

            .status-active {
                background: #dcfce7;
                color: #16a34a;
            }

            .status-warning {
                background: #fef3c7;
                color: #d97706;
            }

            /* Buttons */
            .btn {
                display: inline-flex;
                align-items: center;
                gap: var(--spacing-sm);
                padding: 0.625rem 1.25rem;
                border-radius: var(--border-radius-md);
                font-weight: 500;
                font-size: 0.875rem;
                transition: all var(--transition-normal);
                border: none;
                cursor: pointer;
            }

            .btn-primary {
                background-color: var(--primary-color);
                color: white;
            }

            .btn-primary:hover {
                background-color: var(--primary-hover);
                transform: translateY(-1px);
            }

            .btn-success {
                background-color: var(--success-color);
                color: white;
            }

            .btn-success:hover {
                background-color: #16a34a;
                transform: translateY(-1px);
            }

            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                backdrop-filter: blur(4px);
            }

            .modal-content {
                background-color: white;
                margin: 5% auto;
                padding: var(--spacing-xl);
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-lg);
                width: 90%;
                max-width: 600px;
                position: relative;
            }

            .modal-content h2 {
                font-size: 1.5rem;
                font-weight: 600;
                margin-bottom: var(--spacing-lg);
                display: flex;
                align-items: center;
                gap: var(--spacing-sm);
            }

            /* Form Styles */
            .form-group {
                margin-bottom: var(--spacing-lg);
            }

            .form-group label {
                display: block;
                margin-bottom: var(--spacing-xs);
                color: var(--text-secondary);
                font-weight: 500;
            }

            .form-control {
                width: 100%;
                padding: 0.625rem 1rem;
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius-md);
                transition: all var(--transition-normal);
                font-size: 0.875rem;
            }

            .form-control:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
                outline: none;
            }

            /* Loading Spinner */
            .loading-spinner {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.8);
                backdrop-filter: blur(4px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            }

            .spinner {
                width: 40px;
                height: 40px;
                border: 3px solid var(--border-color);
                border-top: 3px solid var(--primary-color);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* Pagination */
            .pagination {
                margin-top: var(--spacing-lg);
            }

            .page-link {
                color: var(--primary-color);
                padding: 0.5rem 1rem;
                border: 1px solid var(--border-color);
                margin: 0 0.25rem;
                border-radius: var(--border-radius-md);
                transition: all var(--transition-normal);
            }

            .page-link:hover {
                background-color: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .page-item.active .page-link {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
                color: white;
            }

            /* Responsive Design */
            @media (max-width: 768px) {
                .container {
                    padding: var(--spacing-md);
                }

                .main-content {
                    padding: var(--spacing-lg);
                }

                .controls-bar {
                    grid-template-columns: 1fr;
                }

                .filter-controls {
                    grid-template-columns: 1fr;
                }

                .table-responsive {
                    overflow-x: auto;
                }

                .modal-content {
                    margin: 10% auto;
                    padding: var(--spacing-lg);
                    width: 95%;
                }
            }

            .hero-header {
                background: linear-gradient(120deg, #22c1c3 0%, #29d397 100%);
                border-radius: 2rem;
                box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
                padding: 2.5rem 3rem;
                margin-bottom: 2rem;
                color: #fff;
                position: relative;
                overflow: hidden;
                min-height: 180px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: flex-start;
            }

            .hero-header h1 {
                font-size: 2.5rem;
                font-weight: 800;
                margin-bottom: 0.5rem;
                color: #fff;
                text-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }

            .hero-header p {
                font-size: 1.25rem;
                font-weight: 400;
                color: #e0f7fa;
                margin-bottom: 0;
            }

            @media (max-width: 768px) {
                .hero-header {
                    padding: 1.5rem 1rem;
                    min-height: 120px;
                }
                .hero-header h1 {
                    font-size: 1.5rem;
                }
                .hero-header p {
                    font-size: 1rem;
                }
            }

            .stat-card {
                background: #fff;
                border-radius: 1.25rem;
                box-shadow: 0 2px 12px 0 rgba(31, 38, 135, 0.07);
                padding: 1.25rem 1rem;
                text-align: center;
                transition: box-shadow 0.2s;
                min-height: 110px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            .stat-card:hover {
                box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.13);
            }
            .stat-label {
                font-size: 1rem;
                color: #64748b;
                margin-bottom: 0.25rem;
            }
            .stat-value {
                font-size: 2rem;
                font-weight: 700;
                color: #2563eb;
            }
            .stat-total .stat-value { color: #2563eb; }
            .stat-present .stat-value { color: #22c55e; }
            .stat-absent .stat-value { color: #ef4444; }
            .stat-wfh .stat-value { color: #3b82f6; }
            .stat-late .stat-value { color: #f59e0b; }
            .chart-container {
                background: #fff;
                border-radius: 1.25rem;
                box-shadow: 0 2px 12px 0 rgba(31, 38, 135, 0.07);
                padding: 1.5rem;
                min-height: 320px;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            @media (max-width: 768px) {
                .stat-card { min-height: 80px; padding: 0.75rem 0.5rem; }
                .stat-value { font-size: 1.25rem; }
                .chart-container { padding: 0.5rem; min-height: 200px; }
            }

            .custom-stat-card {
                display: flex;
                align-items: center;
                gap: 16px;
                background: #f8fafc;
                border-radius: 18px;
                box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.10);
                padding: 1.25rem 1rem;
                min-height: 90px;
                transition: box-shadow 0.2s;
                border: none;
                margin-bottom: 0;
            }
            .custom-stat-card:hover {
                box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
                background: #f1f5fe;
            }
            .stat-card-icon {
                background: #2563eb;
                color: #fff;
                border-radius: 12px;
                width: 48px;
                height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 2rem;
                box-shadow: 0 2px 8px 0 rgba(37,99,235,0.10);
            }
            .custom-stat-card .stat-label {
                font-size: 1.05rem;
                color: #334155;
                font-weight: 600;
                margin-bottom: 0.15rem;
                text-align: left;
            }
            .custom-stat-card .stat-value {
                font-size: 2.1rem;
                font-weight: 700;
                color: #1e293b;
                text-align: left;
            }
            @media (max-width: 768px) {
                .custom-stat-card {
                    min-height: 60px;
                    padding: 0.75rem 0.5rem;
                    gap: 10px;
                }
                .stat-card-icon {
                    width: 36px;
                    height: 36px;
                    font-size: 1.3rem;
                }
                .custom-stat-card .stat-value {
                    font-size: 1.2rem;
                }
            }

            .attendance-stats-cards {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 24px;
                margin-bottom: 2rem;
            }

            .attendance-stats-cards .custom-stat-card {
                min-width: 210px;
                max-width: 240px;
                flex: 1 1 210px;
                margin: 0;
                background: #f8fafc;
                border-radius: 18px;
                box-shadow: 0 2px 12px 0 rgba(31, 38, 135, 0.08);
                border: 1px solid #e2e8f0;
                transition: box-shadow 0.18s, transform 0.18s;
                display: flex;
                align-items: center;
                gap: 16px;
                padding: 1.1rem 1rem;
                height: 100px;
            }

            .attendance-stats-cards .custom-stat-card:hover {
                box-shadow: 0 6px 24px 0 rgba(31, 38, 135, 0.16);
                background: #e0e7ff;
                transform: translateY(-2px) scale(1.03);
            }

            .attendance-stats-cards .stat-card-icon {
                width: 52px;
                height: 52px;
                font-size: 2.2rem;
                border-radius: 14px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 1px 6px 0 rgba(37,99,235,0.10);
            }

            .attendance-stats-cards .stat-label {
                font-size: 0.98rem;
                color: #64748b;
                font-weight: 500;
                margin-bottom: 0.18rem;
                text-align: left;
                letter-spacing: 0.01em;
            }

            .attendance-stats-cards .stat-value {
                font-size: 2.2rem;
                font-weight: 800;
                color: #1e293b;
                text-align: left;
                line-height: 1.1;
            }

            @media (max-width: 900px) {
                .attendance-stats-cards {
                    gap: 14px;
                }
                .attendance-stats-cards .custom-stat-card {
                    min-width: 160px;
                    max-width: 100%;
                    height: 80px;
                    padding: 0.7rem 0.5rem;
                }
                .attendance-stats-cards .stat-card-icon {
                    width: 36px;
                    height: 36px;
                    font-size: 1.3rem;
                }
                .attendance-stats-cards .stat-value {
                    font-size: 1.2rem;
                }
            }
            @media (max-width: 600px) {
                .attendance-stats-cards {
                    flex-direction: column;
                    align-items: center;
                    gap: 10px;
                }
                .attendance-stats-cards .custom-stat-card {
                    width: 100%;
                    min-width: 0;
                    max-width: 100%;
                    height: auto;
                    justify-content: flex-start;
                }
            }
        </style>

        <!-- Scripts -->
        <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@latest/dist/ionic/ionic.esm.js"></script>
        <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@latest/dist/ionic/ionic.js"></script>
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    </head>
    <body>
        <div class="container">
            <main class="main-content">
                <!-- Nút quay lại Dashboard -->
                <a href="../dashboard_admin_V1.php" class="btn btn-outline-primary mb-3 d-inline-flex align-items-center" style="font-weight:600;font-size:1rem;gap:8px;">
                    <i class="fa fa-arrow-left"></i> Quay lại Dashboard
                </a>
                <div class="hero-header mb-4">
                    <h1>Quản lý chấm công</h1>
                    <p>Quản lý thông tin chấm công của nhân viên</p>
                </div>
                <!-- Card thống kê tổng quan -->
                <div class="attendance-stats-cards mb-4" id="attendanceStatsCards">
                    <div class="custom-stat-card stat-total">
                        <div class="stat-card-icon">
                            <ion-icon name="calendar-clear-outline"></ion-icon>
                        </div>
                        <div>
                            <div class="stat-label">Tổng lượt chấm công</div>
                            <div class="stat-value" id="statTotal">0</div>
                        </div>
                    </div>
                    <div class="custom-stat-card stat-present">
                        <div class="stat-card-icon" style="background:#22c55e;">
                            <ion-icon name="calendar-checkmark-outline"></ion-icon>
                        </div>
                        <div>
                            <div class="stat-label">Có mặt (P)</div>
                            <div class="stat-value" id="statPresent">0</div>
                        </div>
                    </div>
                    <div class="custom-stat-card stat-absent">
                        <div class="stat-card-icon" style="background:#ef4444;">
                            <ion-icon name="calendar-outline"></ion-icon>
                        </div>
                        <div>
                            <div class="stat-label">Vắng mặt (A)</div>
                            <div class="stat-value" id="statAbsent">0</div>
                        </div>
                    </div>
                    <div class="custom-stat-card stat-wfh">
                        <div class="stat-card-icon" style="background:#3b82f6;">
                            <ion-icon name="home-outline"></ion-icon>
                        </div>
                        <div>
                            <div class="stat-label">Làm từ xa (WFH)</div>
                            <div class="stat-value" id="statWFH">0</div>
                        </div>
                    </div>
                    <div class="custom-stat-card stat-late">
                        <div class="stat-card-icon" style="background:#f59e0b;">
                            <ion-icon name="time-outline"></ion-icon>
                        </div>
                        <div>
                            <div class="stat-label">Đi muộn (L)</div>
                            <div class="stat-value" id="statLate">0</div>
                        </div>
                    </div>
                </div>
                <!-- Controls Bar -->
                <div class="controls-bar">
                    <div class="filter-controls">
                        <input type="text" id="searchCode" class="form-control" placeholder="Tìm mã nhân viên...">
                        <input type="text" id="searchName" class="form-control" placeholder="Tìm tên nhân viên...">
                        <input type="date" id="dateFilter" class="form-control">
                        <select id="statusFilter" class="form-control">
                            <option value="">Tất cả trạng thái</option>
                            <option value="P">Có mặt (P)</option>
                            <option value="A">Vắng mặt (A)</option>
                            <option value="L">Nghỉ phép (L)</option>
                            <option value="WFH">Làm việc từ xa (WFH)</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" id="addAttendanceButton">
                            <ion-icon name="add-circle-outline"></ion-icon>
                            Thêm chấm công
                        </button>
                        <button class="btn btn-success" id="exportExcelButton">
                            <ion-icon name="download-outline"></ion-icon>
                            Xuất Excel
                        </button>
                    </div>
                </div>

                <!-- Table Container -->
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Mã nhân viên</th>
                                    <th>Họ tên</th>
                                    <th>Ngày</th>
                                    <th>Giờ vào</th>
                                    <th>Giờ ra</th>
                                    <th>Trạng thái</th>
                                    <th>Ghi chú</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceList">
                                <!-- Dữ liệu sẽ được thêm vào đây bằng JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <nav aria-label="Attendance pagination" style="margin-top:16px;">
                        <ul class="pagination justify-content-center" id="attendancePagination"></ul>
                    </nav>
                </div>
            </main>
        </div>

        <!-- Delete Modal -->
        <div id="deleteModal" class="modal">
            <div class="modal-content">
                <h2>
                    <ion-icon name="warning-outline"></ion-icon>
                    Xác nhận xóa
                </h2>
                <p>Bạn có chắc chắn muốn xóa bản ghi chấm công này?</p>
                <div class="form-actions">
                    <button id="confirmDeleteButton" class="btn btn-danger">
                        <ion-icon name="trash-outline"></ion-icon>
                        Xóa
                    </button>
                    <button id="cancelDeleteButton" class="btn btn-secondary">
                        <ion-icon name="close-outline"></ion-icon>
                        Hủy
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <h2>
                    <ion-icon name="create-outline"></ion-icon>
                    Sửa thông tin điểm danh
                </h2>
                <form id="editForm" onsubmit="event.preventDefault(); updateAttendance();">
                    <input type="hidden" id="attendanceId" name="attendanceId">
                    <div class="form-group">
                        <label for="employeeId">Mã nhân viên:</label>
                        <input type="text" id="employeeId" name="employeeId" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="attendanceDate">Ngày điểm danh:</label>
                        <input type="date" id="attendanceDate" name="attendanceDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="attendanceSymbol">Ký hiệu:</label>
                        <select id="attendanceSymbol" name="attendanceSymbol" class="form-control" required>
                            <option value="P">P - Có mặt</option>
                            <option value="A">A - Vắng mặt</option>
                            <option value="L">L - Đi muộn</option>
                            <option value="WFH">WFH - Làm việc từ xa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notes">Ghi chú:</label>
                        <textarea id="notes" name="notes" class="form-control"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <ion-icon name="save-outline"></ion-icon>
                            Lưu thay đổi
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">
                            <ion-icon name="close-outline"></ion-icon>
                            Hủy
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
        </div>

        <!-- Scripts -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="css/common.css"></script>
        <script src="js/auth_utils.js"></script>
        <script src="js/api_service.js"></script>
        <script src="js/attendance-display.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>
        let currentAttendanceData = [];
        let deleteAttendanceId = null;
        let currentPage = 1;
        const pageSize = 10;
        let filterCode = '';
        let filterName = '';
        let filterDate = '';
        let filterStatus = '';

        async function loadAttendanceData() {
            try {
                const response = await fetch('/qlnhansu_V3/backend/src/api/v1/attendance.php?action=getAll');
                const data = await response.json();
                console.log('API DATA:', data);
                if (data.success && Array.isArray(data.data)) {
                    currentAttendanceData = data.data;
                    currentPage = 1;
                    updateAttendanceTable();
                    updateStatsAndChart(currentAttendanceData);
                } else {
                    alert('Lỗi khi tải dữ liệu chấm công');
                }
            } catch (error) {
                alert('Lỗi kết nối server');
                console.error('Error:', error);
            }
        }

        function displayAttendanceData(attendanceData) {
            const attendanceList = document.getElementById('attendanceList');
            attendanceList.innerHTML = '';
            if (!Array.isArray(attendanceData) || attendanceData.length === 0) {
                attendanceList.innerHTML = '<tr><td colspan="8">Không có dữ liệu</td></tr>';
                return;
            }
            // Sắp xếp: Ngày giảm dần, trạng thái ưu tiên, tên nhân viên A-Z
            attendanceData.sort((a, b) => {
                // So sánh ngày
                const dateA = new Date(a.attendance_date);
                const dateB = new Date(b.attendance_date);
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateB - dateA; // Mới nhất lên đầu
                }
                // Ưu tiên trạng thái: Hết hạn > Sắp hết hạn > Còn hiệu lực
                const getStatusPriority = (r) => {
                    if (r.attendance_symbol === 'A' || r.status_text === 'Hết hạn') return 1;
                    if (r.status_text === 'Sắp hết hạn') return 2;
                    if (r.attendance_symbol === 'P' || r.status_text === 'Còn hiệu lực') return 3;
                    return 4;
                };
                const priA = getStatusPriority(a);
                const priB = getStatusPriority(b);
                if (priA !== priB) return priA - priB;
                // Nếu cùng trạng thái, sắp xếp theo tên
                return a.full_name.localeCompare(b.full_name, 'vi', {sensitivity: 'base'});
            });
            attendanceData.forEach(record => {
                const row = document.createElement('tr');
                // Xác định text và class cho trạng thái
                let statusText = '';
                let statusClass = 'status-badge';
                if (record.attendance_symbol === 'A' || record.status_text === 'Hết hạn') {
                    statusText = 'Hết hạn';
                    statusClass += ' status-expired';
                } else if (record.attendance_symbol === 'P' || record.status_text === 'Còn hiệu lực') {
                    statusText = 'Còn hiệu lực';
                    statusClass += ' status-active';
                } else if (record.status_text === 'Sắp hết hạn') {
                    statusText = 'Sắp hết hạn';
                    statusClass += ' status-warning';
                } else {
                    statusText = record.attendance_symbol || '-';
                }
                row.innerHTML = `
                    <td>${record.employee_code || '-'}</td>
                    <td>${record.employee_name || '-'}</td>
                    <td>${record.attendance_date}</td>
                    <td>${record.check_in_time || '-'}</td>
                    <td>${record.check_out_time || '-'}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>${record.notes || '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editAttendance(${record.attendance_id})">
                            <ion-icon name="create-outline"></ion-icon>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="confirmDelete(${record.attendance_id})">
                            <ion-icon name="trash-outline"></ion-icon>
                        </button>
                    </td>
                `;
                attendanceList.appendChild(row);
            });
        }

        function editAttendance(id) {
            const record = currentAttendanceData.find(r => r.attendance_id == id);
            if (!record) return;
            document.getElementById('attendanceId').value = record.attendance_id;
            document.getElementById('employeeId').value = record.employee_id;
            document.getElementById('attendanceDate').value = record.attendance_date;
            document.getElementById('attendanceSymbol').value = record.attendance_symbol;
            document.getElementById('notes').value = record.notes || '';
            document.getElementById('editModal').style.display = 'block';
        }

        function confirmDelete(id) {
            deleteAttendanceId = id;
            document.getElementById('deleteModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('deleteModal').style.display = 'none';
        }

        document.getElementById('cancelDeleteButton').onclick = closeModal;
        document.getElementById('confirmDeleteButton').onclick = function() {
            if (!deleteAttendanceId) return;
            // Gọi API xóa ở đây, ví dụ:
            fetch(`/qlnhansu_V3/backend/src/api/v1/attendance.php?action=delete&id=${deleteAttendanceId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        loadAttendanceData();
                    } else {
                        alert('Xóa thất bại!');
                    }
                    closeModal();
                })
                .catch(() => {
                    alert('Lỗi khi xóa!');
                    closeModal();
                });
        };

        document.getElementById('addAttendanceButton').onclick = function() {
            // Reset form
            document.getElementById('editForm').reset();
            document.getElementById('attendanceId').value = '';
            // Đặt tiêu đề modal
            document.querySelector('#editModal h2').innerHTML = '<ion-icon name="create-outline"></ion-icon> Thêm chấm công mới';
            // Hiện modal
            document.getElementById('editModal').style.display = 'block';
        };

        document.getElementById('exportExcelButton').onclick = function() {
            if (!currentAttendanceData || currentAttendanceData.length === 0) {
                alert('Không có dữ liệu để xuất!');
                return;
            }
            // Chuyển đổi dữ liệu sang mảng object cho Excel
            const exportData = currentAttendanceData.map(record => ({
                'Mã nhân viên': record.employee_code || '-',
                'Họ tên': record.employee_name || '-',
                'Ngày': record.attendance_date,
                'Giờ vào': record.check_in_time || '-',
                'Giờ ra': record.check_out_time || '-',
                'Trạng thái': (record.attendance_symbol === 'A' ? 'Hết hạn' : (record.attendance_symbol === 'P' ? 'Còn hiệu lực' : (record.status_text || record.attendance_symbol || '-'))),
                'Ghi chú': record.notes || '-'
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ChamCong');
            XLSX.writeFile(wb, 'danh_sach_cham_cong.xlsx');
        };

        document.getElementById('searchCode').oninput = function(e) {
            filterCode = e.target.value.trim().toLowerCase();
            currentPage = 1;
            updateAttendanceTable();
        };
        document.getElementById('searchName').oninput = function(e) {
            filterName = e.target.value.trim().toLowerCase();
            currentPage = 1;
            updateAttendanceTable();
        };
        document.getElementById('dateFilter').onchange = function(e) {
            filterDate = e.target.value;
            currentPage = 1;
            updateAttendanceTable();
        };
        document.getElementById('statusFilter').onchange = function(e) {
            filterStatus = e.target.value;
            currentPage = 1;
            updateAttendanceTable();
        };

        function updateAttendanceTable() {
            let data = currentAttendanceData.slice();
            // Lọc theo mã nhân viên
            if (filterCode) {
                data = data.filter(r => (r.employee_code || '').toLowerCase().includes(filterCode));
            }
            // Lọc theo tên nhân viên
            if (filterName) {
                data = data.filter(r => (r.employee_name || '').toLowerCase().includes(filterName));
            }
            // Lọc theo ngày
            if (filterDate) {
                data = data.filter(r => r.attendance_date === filterDate);
            }
            // Lọc theo trạng thái
            if (filterStatus) {
                data = data.filter(r => r.attendance_symbol === filterStatus);
            }
            // Sắp xếp và phân trang như cũ
            data.sort((a, b) => {
                const dateA = new Date(a.attendance_date);
                const dateB = new Date(b.attendance_date);
                if (dateA.getTime() !== dateB.getTime()) return dateB - dateA;
                const getStatusPriority = (r) => {
                    if (r.attendance_symbol === 'A' || r.status_text === 'Hết hạn') return 1;
                    if (r.status_text === 'Sắp hết hạn') return 2;
                    if (r.attendance_symbol === 'P' || r.status_text === 'Còn hiệu lực') return 3;
                    return 4;
                };
                const priA = getStatusPriority(a);
                const priB = getStatusPriority(b);
                if (priA !== priB) return priA - priB;
                return a.employee_name.localeCompare(b.employee_name, 'vi', {sensitivity: 'base'});
            });
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            displayAttendanceData(data.slice(start, end));
            renderPagination(data.length);
        }

        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / pageSize);
            const pagination = document.getElementById('attendancePagination');
            pagination.innerHTML = '';
            if (totalPages <= 1) return;
            // Previous
            const prevLi = document.createElement('li');
            prevLi.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
            prevLi.innerHTML = `<a class="page-link" href="#">&laquo;</a>`;
            prevLi.onclick = function(e) { e.preventDefault(); if (currentPage > 1) { currentPage--; updateAttendanceTable(); } };
            pagination.appendChild(prevLi);
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = 'page-item' + (i === currentPage ? ' active' : '');
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.onclick = function(e) { e.preventDefault(); if (currentPage !== i) { currentPage = i; updateAttendanceTable(); } };
                pagination.appendChild(li);
            }
            // Next
            const nextLi = document.createElement('li');
            nextLi.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
            nextLi.innerHTML = `<a class="page-link" href="#">&raquo;</a>`;
            nextLi.onclick = function(e) { e.preventDefault(); if (currentPage < totalPages) { currentPage++; updateAttendanceTable(); } };
            pagination.appendChild(nextLi);
        }

        function updateStatsAndChart(attendanceData) {
            // Đếm số lượng theo trạng thái
            let present = 0, absent = 0, wfh = 0, late = 0;
            if (Array.isArray(attendanceData)) {
                attendanceData.forEach(r => {
                    if (r && r.attendance_symbol) {
                        if (r.attendance_symbol === 'P') present++;
                        else if (r.attendance_symbol === 'A') absent++;
                        else if (r.attendance_symbol === 'WFH') wfh++;
                        else if (r.attendance_symbol === 'L') late++;
                    }
                });
            }
            const total = present + absent + wfh + late;
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPresent').textContent = present;
            document.getElementById('statAbsent').textContent = absent;
            document.getElementById('statWFH').textContent = wfh;
            document.getElementById('statLate').textContent = late;
            // Pie Chart
            if (window.attendancePieChart) window.attendancePieChart.destroy();
            const ctx = document.getElementById('attendancePieChart').getContext('2d');
            window.attendancePieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Có mặt (P)', 'Vắng mặt (A)', 'Làm từ xa (WFH)', 'Đi muộn (L)'],
                    datasets: [{
                        data: [present, absent, wfh, late],
                        backgroundColor: [
                            '#22c55e', '#ef4444', '#3b82f6', '#f59e0b'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Tỷ lệ trạng thái chấm công' }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', loadAttendanceData);
        </script>
    </body>
</html>
