<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta
            http-equiv="Content-Security-Policy"
            content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com http://localhost:4000 http://localhost; object-src 'none';"
        />
        <title>Chấm công hằng ngày - VNPT</title>
        
        <!-- External CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        
        <!-- Internal CSS -->
        <link rel="stylesheet" href="css/attendance.css" />
        <link rel="stylesheet" href="/assets/css/notifications.css">
        <link rel="stylesheet" href="/assets/css/loading.css">
        <link rel="stylesheet" href="/assets/css/style.css">
        <link rel="stylesheet" href="css/common.css">
        
        <style>
            :root {
                /* Color Variables */
                --primary-color: #0056b3;
                --primary-hover: #004494;
                --secondary-color: #6c757d;
                --success-color: #28a745;
                --danger-color: #dc3545;
                --warning-color: #ffc107;
                --info-color: #17a2b8;
                --light-color: #f8f9fa;
                --dark-color: #343a40;
                --border-color: #dee2e6;
                --text-primary: #212529;
                --text-secondary: #495057;
                
                /* Spacing Variables */
                --spacing-xs: 0.25rem;
                --spacing-sm: 0.5rem;
                --spacing-md: 1rem;
                --spacing-lg: 1.5rem;
                --spacing-xl: 2rem;
                
                /* Border Radius */
                --border-radius-sm: 4px;
                --border-radius-md: 8px;
                --border-radius-lg: 12px;
                
                /* Shadows */
                --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
                --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
                --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
                
                /* Transitions */
                --transition-fast: 0.2s ease;
                --transition-normal: 0.3s ease;
            }

            /* Base Styles */
            body {
                font-family: 'Inter', sans-serif;
                background-color: var(--light-color);
                color: var(--text-primary);
                line-height: 1.5;
            }

            /* Layout */
            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: var(--spacing-lg);
            }

            .main-content {
                background: white;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-md);
                padding: var(--spacing-xl);
                min-height: calc(100vh - 40px);
            }

            /* Navigation */
            .attendance-nav {
                background: white;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-sm);
                padding: var(--spacing-lg);
                margin-bottom: var(--spacing-lg);
            }

            .nav-buttons {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: var(--spacing-md);
            }

            .nav-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: var(--spacing-sm);
                padding: var(--spacing-md) var(--spacing-lg);
                background-color: var(--light-color);
                color: var(--text-secondary);
                border-radius: var(--border-radius-md);
                text-decoration: none;
                font-weight: 500;
                transition: all var(--transition-normal);
                border: 1px solid var(--border-color);
            }

            .nav-btn:hover {
                background-color: var(--primary-color);
                color: white;
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

            .nav-btn ion-icon {
                font-size: 1.2rem;
            }

            /* Header */
            .content-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: var(--spacing-xl);
                padding-bottom: var(--spacing-lg);
                border-bottom: 2px solid var(--border-color);
            }

            .content-header h1 {
                color: var(--text-primary);
                font-size: 2rem;
                font-weight: 600;
                margin: 0;
                display: flex;
                align-items: center;
                gap: var(--spacing-sm);
            }

            /* Controls Bar */
            .controls-bar {
                background: white;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-sm);
                padding: var(--spacing-lg);
                margin-bottom: var(--spacing-lg);
                display: grid;
                grid-template-columns: 1fr auto;
                gap: var(--spacing-lg);
                align-items: center;
            }

            .filter-controls {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: var(--spacing-md);
            }

            /* Table Styles */
            .table-container {
                background: white;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-sm);
                padding: var(--spacing-lg);
                overflow: hidden;
            }

            .table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
            }

            .table th {
                background-color: var(--light-color);
                color: var(--text-secondary);
                font-weight: 600;
                padding: var(--spacing-md) var(--spacing-lg);
                text-align: left;
                border-bottom: 2px solid var(--border-color);
            }

            .table td {
                padding: var(--spacing-md) var(--spacing-lg);
                border-bottom: 1px solid var(--border-color);
                color: var(--text-secondary);
            }

            .table tbody tr:hover {
                background-color: var(--light-color);
            }

            /* Status Badges */
            .status-badge {
                display: inline-block;
                padding: 2px 10px;
                border-radius: 8px;
                font-size: 13px;
                font-weight: 600;
                text-align: center;
                margin: 2px 0;
                color: #333;
                background: #f3f3f3;
                letter-spacing: 0.2px;
            }

            .status-expired {
                background: #fdeaea;
                color: #d32f2f;
                border: 1px solid #f5c6cb;
            }

            .status-active {
                background: #e6f4ea;
                color: #388e3c;
                border: 1px solid #b7dfc8;
            }

            .status-warning {
                background: #fff8e1;
                color: #bfa100;
                border: 1px solid #ffe082;
            }

            /* Buttons */
            .btn {
                display: inline-flex;
                align-items: center;
                gap: var(--spacing-sm);
                padding: var(--spacing-sm) var(--spacing-lg);
                border-radius: var(--border-radius-md);
                font-weight: 500;
                transition: all var(--transition-normal);
                border: none;
                cursor: pointer;
            }

            .btn-primary {
                background-color: var(--primary-color);
                color: white;
            }

            .btn-primary:hover {
                background-color: var(--primary-hover);
                transform: translateY(-1px);
            }

            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                backdrop-filter: blur(4px);
            }

            .modal-content {
                background-color: white;
                margin: 5% auto;
                padding: var(--spacing-xl);
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow-lg);
                width: 90%;
                max-width: 600px;
                position: relative;
            }

            /* Form Styles */
            .form-group {
                margin-bottom: var(--spacing-lg);
            }

            .form-group label {
                display: block;
                margin-bottom: var(--spacing-xs);
                color: var(--text-secondary);
                font-weight: 500;
            }

            .form-control {
                width: 100%;
                padding: var(--spacing-md);
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius-md);
                transition: all var(--transition-normal);
            }

            .form-control:focus {
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(0,86,179,0.15);
                outline: none;
            }

            /* Loading Spinner */
            .loading-spinner {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            }

            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid var(--border-color);
                border-top: 4px solid var(--primary-color);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            /* Responsive Design */
            @media (max-width: 768px) {
                .container {
                    padding: var(--spacing-md);
                }

                .main-content {
                    padding: var(--spacing-lg);
                }

                .controls-bar {
                    grid-template-columns: 1fr;
                }

                .filter-controls {
                    grid-template-columns: 1fr;
                }

                .table-responsive {
                    overflow-x: auto;
                }

                .modal-content {
                    margin: 10% auto;
                    padding: var(--spacing-lg);
                }
            }
        </style>

        <!-- Scripts -->
        <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@latest/dist/ionic/ionic.esm.js"></script>
        <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@latest/dist/ionic/ionic.js"></script>
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    </head>
    <body>
        <div class="container">
            <main class="main-content">
                <!-- Nút quay lại Dashboard -->
                <a href="../dashboard_admin_V1.php" class="btn btn-outline-primary mb-3 d-inline-flex align-items-center" style="font-weight:600;font-size:1rem;gap:8px;">
                    <i class="fa fa-arrow-left"></i> Quay lại Dashboard
                </a>

                <!-- Navigation Bar -->
                <div class="attendance-nav mb-4">
                    <div class="nav-buttons">
                        <a href="attendance_History.html" class="nav-btn">
                            <ion-icon name="time-outline"></ion-icon>
                            Lịch sử chấm công
                        </a>
                        <a href="check.html" class="nav-btn">
                            <ion-icon name="checkmark-circle-outline"></ion-icon>
                            Chấm công
                        </a>
                    </div>
                </div>

                <div class="content-header">
                    <h1>
                        <ion-icon name="calendar-outline"></ion-icon>
                        Bảng chấm công hằng ngày
                    </h1>
                </div>

                <!-- Controls Bar -->
                <div class="controls-bar">
                    <div class="filter-controls">
                        <input type="date" id="dateFilter" class="form-control" onchange="applyFilters()">
                        <select id="statusFilter" class="form-control" onchange="applyFilters()">
                            <option value="">Tất cả trạng thái</option>
                            <option value="P">Có mặt (P)</option>
                            <option value="A">Vắng mặt (A)</option>
                            <option value="L">Nghỉ phép (L)</option>
                            <option value="WFH">Làm việc từ xa (WFH)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="addAttendanceButton">
                        <ion-icon name="add-circle-outline"></ion-icon>
                        Thêm chấm công
                    </button>
                </div>

                <!-- Table Container -->
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Mã nhân viên</th>
                                    <th>Họ tên</th>
                                    <th>Ngày</th>
                                    <th>Giờ vào</th>
                                    <th>Giờ ra</th>
                                    <th>Trạng thái</th>
                                    <th>Ghi chú</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceList">
                                <!-- Dữ liệu sẽ được thêm vào đây bằng JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <!-- Delete Modal -->
        <div id="deleteModal" class="modal">
            <div class="modal-content">
                <h2>
                    <ion-icon name="warning-outline"></ion-icon>
                    Xác nhận xóa
                </h2>
                <p>Bạn có chắc chắn muốn xóa bản ghi chấm công này?</p>
                <div class="form-actions">
                    <button id="confirmDeleteButton" class="btn btn-danger">
                        <ion-icon name="trash-outline"></ion-icon>
                        Xóa
                    </button>
                    <button id="cancelDeleteButton" class="btn btn-secondary">
                        <ion-icon name="close-outline"></ion-icon>
                        Hủy
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <h2>
                    <ion-icon name="create-outline"></ion-icon>
                    Sửa thông tin điểm danh
                </h2>
                <form id="editForm" onsubmit="event.preventDefault(); updateAttendance();">
                    <input type="hidden" id="attendanceId" name="attendanceId">
                    <div class="form-group">
                        <label for="employeeId">Mã nhân viên:</label>
                        <input type="text" id="employeeId" name="employeeId" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="attendanceDate">Ngày điểm danh:</label>
                        <input type="date" id="attendanceDate" name="attendanceDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="attendanceSymbol">Ký hiệu:</label>
                        <select id="attendanceSymbol" name="attendanceSymbol" class="form-control" required>
                            <option value="P">P - Có mặt</option>
                            <option value="A">A - Vắng mặt</option>
                            <option value="L">L - Đi muộn</option>
                            <option value="WFH">WFH - Làm việc từ xa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notes">Ghi chú:</label>
                        <textarea id="notes" name="notes" class="form-control"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <ion-icon name="save-outline"></ion-icon>
                            Lưu thay đổi
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">
                            <ion-icon name="close-outline"></ion-icon>
                            Hủy
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
        </div>

        <!-- Scripts -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="css/common.css"></script>
        <script src="js/auth_utils.js"></script>
        <script src="js/api_service.js"></script>
        <script src="js/attendance-display.js"></script>

        <script>
        async function loadAttendanceData() {
            try {
                const response = await fetch('/qlnhansu_V3/backend/src/api/v1/attendance.php?action=getAll');
                const data = await response.json();
                console.log('API DATA:', data);
                if (data.success && Array.isArray(data.data)) {
                    displayAttendanceData(data.data);
                } else {
                    alert('Lỗi khi tải dữ liệu chấm công');
                }
            } catch (error) {
                alert('Lỗi kết nối server');
                console.error('Error:', error);
            }
        }

        function displayAttendanceData(attendanceData) {
            const attendanceList = document.getElementById('attendanceList');
            attendanceList.innerHTML = '';
            if (!Array.isArray(attendanceData) || attendanceData.length === 0) {
                attendanceList.innerHTML = '<tr><td colspan="8">Không có dữ liệu</td></tr>';
                return;
            }
            // Sắp xếp: Ngày giảm dần, trạng thái ưu tiên, tên nhân viên A-Z
            attendanceData.sort((a, b) => {
                // So sánh ngày
                const dateA = new Date(a.attendance_date);
                const dateB = new Date(b.attendance_date);
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateB - dateA; // Mới nhất lên đầu
                }
                // Ưu tiên trạng thái: Hết hạn > Sắp hết hạn > Còn hiệu lực
                const getStatusPriority = (r) => {
                    if (r.attendance_symbol === 'A' || r.status_text === 'Hết hạn') return 1;
                    if (r.status_text === 'Sắp hết hạn') return 2;
                    if (r.attendance_symbol === 'P' || r.status_text === 'Còn hiệu lực') return 3;
                    return 4;
                };
                const priA = getStatusPriority(a);
                const priB = getStatusPriority(b);
                if (priA !== priB) return priA - priB;
                // Nếu cùng trạng thái, sắp xếp theo tên
                return a.full_name.localeCompare(b.full_name, 'vi', {sensitivity: 'base'});
            });
            attendanceData.forEach(record => {
                const row = document.createElement('tr');
                // Xác định text và class cho trạng thái
                let statusText = '';
                let statusClass = 'status-badge';
                if (record.attendance_symbol === 'A' || record.status_text === 'Hết hạn') {
                    statusText = 'Hết hạn';
                    statusClass += ' status-expired';
                } else if (record.attendance_symbol === 'P' || record.status_text === 'Còn hiệu lực') {
                    statusText = 'Còn hiệu lực';
                    statusClass += ' status-active';
                } else if (record.status_text === 'Sắp hết hạn') {
                    statusText = 'Sắp hết hạn';
                    statusClass += ' status-warning';
                } else {
                    statusText = record.attendance_symbol || '-';
                }
                row.innerHTML = `
                    <td>${record.employee_id}</td>
                    <td>${record.full_name}</td>
                    <td>${record.attendance_date}</td>
                    <td>${record.check_in_time || '-'}</td>
                    <td>${record.check_out_time || '-'}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>${record.notes || '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editAttendance(${record.attendance_id})">
                            <ion-icon name="create-outline"></ion-icon>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="confirmDelete(${record.attendance_id})">
                            <ion-icon name="trash-outline"></ion-icon>
                        </button>
                    </td>
                `;
                attendanceList.appendChild(row);
            });
        }

        // Dummy functions for demo
        function editAttendance(id) {
            alert('Sửa bản ghi: ' + id);
        }
        function confirmDelete(id) {
            alert('Xóa bản ghi: ' + id);
        }

        document.addEventListener('DOMContentLoaded', loadAttendanceData);
        </script>
    </body>
</html>
